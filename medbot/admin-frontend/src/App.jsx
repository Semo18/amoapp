// src/App.jsx
import { useState, useEffect, useMemo } from "react"; // —Ö—É–∫-—Å–æ—Å—Ç–æ—è–Ω–∏—è/—ç—Ñ—Ñ–µ–∫—Ç
// üî¥ –¥–æ–±–∞–≤–∏–ª useMemo –¥–ª—è –≤—ã—á–∏—Å–ª—è–µ–º–æ–≥–æ —Ñ–ª–∞–≥–∞ isCustomReady
import UserMessages from "./UserMessages"; // –≤–ª–æ–∂–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏

// –ë–∞–∑–æ–≤—ã–π URL API –±–µ—Ä—ë–º –∏–∑ Vite env; –ø–∞–¥–µ–Ω–∏–µ –Ω–∞–∑–∞–¥ ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
// –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å URL –¥–∞–∂–µ –±–µ–∑ .env.
const API = import.meta.env.VITE_API_BASE || ""; // üî¥ fallback –¥–æ–±–∞–≤–ª–µ–Ω

export default function App() {
  // –¢–µ–∫—É—â–∞—è –≤–∫–ª–∞–¥–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: ¬´chat¬ª –∏–ª–∏ ¬´analytics¬ª.
  const [tab, setTab] = useState("chat");

  // –ö—ç—à —á–∞—Ç–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Å–ø–∏—Å–∫–∞.
  const [chats, setChats] = useState([]);

  // –°–≤–æ–¥–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∏—Å–ª–∞).
  const [summary, setSummary] = useState({});

  // –§–ª–∞–≥ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–±—â–∏–π –¥–ª—è –≤–∫–ª–∞–¥–æ–∫).
  const [loading, setLoading] = useState(false);

  // –í—ã–±—Ä–∞–Ω–Ω—ã–π —á–∞—Ç (id) –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏; null ‚Äî —Å–ø–∏—Å–æ–∫.
  const [selectedChat, setSelectedChat] = useState(null);

  // –í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö.
  // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª.
  const [period, setPeriod] = useState("day");

  // –ü–æ–ª—è –¥–∞—Ç –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (date inputs).
  const [dateFrom, setDateFrom] = useState(""); // —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD
  const [dateTo, setDateTo] = useState(""); // —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD

  // –í—ã—á–∏—Å–ª—è–µ–º, ¬´–≥–æ—Ç–æ–≤¬ª –ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–µ—Ä–∏–æ–¥: –æ–±–µ –¥–∞—Ç—ã –∑–∞–¥–∞–Ω—ã
  // –∏ –ø—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∑–∂–µ –ª–µ–≤–æ–π. –≠—Ç–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ—Ç
  // –ø–æ–ª—É–∑–∞–¥–∞–Ω–Ω—ã–µ –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ API.
  const isCustomReady = useMemo(() => { // üî¥ useMemo –≤–º–µ—Å—Ç–æ –∏–Ω–ª–∞–π–Ω-–≤—ã—Ä–∞–∂.
    // –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã –≤—Å–µ–≥–¥–∞ ¬´–≥–æ—Ç–æ–≤—ã¬ª.
    if (period !== "custom") return true;
    // –î–ª—è custom –æ–±–µ –¥–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–¥–∞–Ω—ã –∏ –≤–∞–ª–∏–¥–Ω—ã.
    if (!dateFrom || !dateTo) return false;
    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–∞–∫ –¥–∞—Ç—ã; date_to —Å—Ç—Ä–æ–≥–æ –±–æ–ª—å—à–µ date_from.
    return new Date(dateTo) > new Date(dateFrom);
  }, [period, dateFrom, dateTo]); // –∑–∞–≤–∏—Å–∏–º –æ—Ç –≤—Ö–æ–¥–æ–≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è

  // –£—Ç–∏–ª–∏—Ç–∞ —Å–±–æ—Ä–∫–∏ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥ –æ–±–∞ —Ä–µ–∂–∏–º–∞.
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º URLSearchParams, —á—Ç–æ–±—ã –æ–¥–∏–Ω–∞–∫–æ–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
  // –µ–≥–æ —Å /chats –∏ /analytics/summary.
  function buildPeriodParams() {
    const params = new URLSearchParams(); // –ø—É—Å—Ç–æ–π –Ω–∞–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if (period === "custom") {
      // –î–ª—è custom –ø–µ—Ä–µ–¥–∞—ë–º —è–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã (–±–µ–∫ –æ–∂–∏–¥–∞–µ—Ç –∏–º–µ–Ω–Ω–æ –∏—Ö).
      if (dateFrom) params.set("date_from", dateFrom);
      if (dateTo) params.set("date_to", dateTo);
    } else {
      // –î–ª—è –ø—Ä–µ—Å–µ—Ç–æ–≤ ‚Äî –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä ¬´period¬ª.
      params.set("period", period);
    }
    return params; // —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  }

  useEffect(() => {
    // –ê–±–æ—Ä—Ç-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–º–µ–Ω—è—Ç—å fetch –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∞–∂–µ
    // –∏ —Å–º–µ–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–æ–∫ –∏ setState
    // –Ω–∞ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ.
    const ac = new AbortController(); // üî¥ –≤–º–µ—Å—Ç–æ —Ñ–ª–∞–≥–∞ cancelled

    // –ï–¥–∏–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫: –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∫–ª–∞–¥–∫–∏ —Ç—è–Ω–µ–º —Ä–∞–∑–Ω—ã–µ
    // —Ä–µ—Å—É—Ä—Å—ã, –Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–∏–æ–¥ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫.
    async function load() {
      // –ï—Å–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–µ—Ä–∏–æ–¥ ¬´—Å—ã—Ä–æ–π¬ª, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      // –∏ –Ω–µ –¥–µ–ª–∞–µ–º —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—Ä–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥).
      if (!isCustomReady) {
        setChats([]); // –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã UI –Ω–µ –ø—É—Ç–∞–ª
        setSummary({}); // —Å–±—Ä–æ—Å –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
        setLoading(false); // —Å–Ω–∏–º–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        return; // –≤—ã—Ö–æ–¥–∏–º –¥–æ fetch
      }

      setLoading(true); // –≤–∫–ª—é—á–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
      try {
        const p = buildPeriodParams(); // —Å–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–∏–æ–¥–∞
        if (tab === "chat") {
          // –î–ª—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –ø–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å —É—á—ë—Ç–æ–º –ø–µ—Ä–∏–æ–¥–∞.
          const url = `${API}/chats?${p.toString()}`; // –∏—Ç–æ–≥–æ–≤—ã–π URL
          const r = await fetch(url, { signal: ac.signal }); // üî¥ abortable
          if (!r.ok) {
            // –Ø–≤–Ω–æ –±—Ä–æ—Å–∞–µ–º –Ω–∞ non-2xx, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ catch.
            throw new Error(`HTTP ${r.status} ${r.statusText}`); // üî¥
          }
          const data = await r.json(); // JSON-–æ—Ç–≤–µ—Ç API
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫, –Ω–æ—Ä–º–∞–ª–∏–∑—É—è –Ω–µ–≤–µ—Ä–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
          setChats(Array.isArray(data?.items) ? data.items : []); // safe
        } else {
          // –î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–≤–æ–¥–∫—É.
          const url = `${API}/analytics/summary?${p.toString()}`;
          const r = await fetch(url, { signal: ac.signal }); // üî¥ abortable
          if (!r.ok) {
            throw new Error(`HTTP ${r.status} ${r.statusText}`); // üî¥
          }
          const data = await r.json(); // JSON-–æ—Ç–≤–µ—Ç —Å–æ —Å–≤–æ–¥–∫–æ–π
          setSummary(data ?? {}); // –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç
        }
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç–º–µ–Ω—ã; –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –ª–æ–≥–∏—Ä—É–µ–º –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º.
        if (e.name !== "AbortError") { // üî¥ —Ñ–∏–ª—å—Ç—Ä—É–µ–º cancel
          console.error(e); // –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å–µ—Ç–∏/—Å–µ—Ä–≤–µ—Ä–∞
          setChats([]); // —Å–±—Ä–æ—Å —Å–ø–∏—Å–∫–∞
          setSummary({}); // —Å–±—Ä–æ—Å —Å–≤–æ–¥–∫–∏
        }
      } finally {
        // –ó–∞–≤–µ—Ä—à–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ –±—ã–ª –æ—Ç–º–µ–Ω—ë–Ω.
        if (!ac.signal.aborted) setLoading(false); // üî¥ guard
      }
    }

    // –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Å–º–µ–Ω–µ –≤–∫–ª–∞–¥–∫–∏/–ø–µ—Ä–∏–æ–¥–∞/–¥–∞—Ç.
    load(); // –∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É

    // –û—Ç–º–µ–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∞–∂–µ/–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
    return () => ac.abort(); // üî¥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Ç–º–µ–Ω–∞ fetch
  }, [tab, period, dateFrom, dateTo, isCustomReady]); // –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞

  // –†–µ–Ω–¥–µ—Ä–∏–º –ø—Ä–æ—Å—Ç–æ–π –º–∞–∫–µ—Ç: –∑–∞–≥–æ–ª–æ–≤–æ–∫, –Ω–∞–≤–∏–≥–∞—Ü–∏—è, –∫–æ–Ω—Ç–µ–Ω—Ç —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏.
  return (
    <div
      // –ë–∞–∑–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.
      style={{
        fontFamily:
          "system-ui, -apple-system, Segoe UI, Roboto, sans-serif",
        padding: "32px 24px",
        maxWidth: 900,
        margin: "0 auto",
      }}
    >
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –º–µ–¥–±–æ—Ç–∞. */}
      <h1 style={{ margin: "8px 0 16px" }}>ü©∫ MedBot ‚Äî –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h1>

      {/* –ü—Ä–æ—Å—Ç–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è: –¥–≤–µ –∫–Ω–æ–ø–∫–∏-–≤–∫–ª–∞–¥–∫–∏. */}
      <nav style={{ marginBottom: 20, display: "flex", gap: 8 }}>
        <button
          // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –∏ —Å–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞.
          onClick={() => {
            setTab("chat");
            setSelectedChat(null);
          }}
          disabled={tab === "chat"} // –±–ª–æ–∫–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        >
          üí¨ –ß–∞—Ç—ã
        </button>
        <button
          // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
          onClick={() => setTab("analytics")}
          disabled={tab === "analytics"} // –±–ª–æ–∫–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        >
          üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
        </button>
      </nav>

      {/* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏. */}
      {loading && <p>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>}

      {/* –í–∫–ª–∞–¥–∫–∞ ¬´–ß–∞—Ç—ã¬ª: —Å–ø–∏—Å–æ–∫ –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥. */}
      {tab === "chat" && !loading && (
        <div>
          {/* –ü–æ–∫–∞ —á–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫. */}
          {!selectedChat && (
            <>
              <h2 style={{ marginBottom: 12 }}>–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤</h2>

              {/* –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤. */}
              <div
                style={{
                  display: "flex",
                  gap: 8,
                  alignItems: "center",
                  margin: "0 0 12px",
                }}
              >
                <label style={{ opacity: 0.8 }}>–ü–µ—Ä–∏–æ–¥:</label>
                <select
                  // –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π select —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–µ—Ä–∏–æ–¥–∞.
                  value={period}
                  onChange={(e) => setPeriod(e.target.value)}
                >
                  <option value="day">–î–µ–Ω—å</option>
                  <option value="week">–ù–µ–¥–µ–ª—è</option>
                  <option value="month">30 –¥–Ω–µ–π</option>
                  <option value="this_month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
                  <option value="prev_month">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</option>
                  <option value="custom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥</option>
                </select>

                {/* –ü—Ä–∏ custom ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–∞—Ç. */}
                {period === "custom" && (
                  <>
                    <input
                      type="date"
                      value={dateFrom}
                      onChange={(e) => setDateFrom(e.target.value)}
                      title="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)"
                    />
                    <input
                      type="date"
                      value={dateTo}
                      onChange={(e) => setDateTo(e.target.value)}
                      title="–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞ (–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)"
                    />
                  </>
                )}
              </div>

              {/* –ü–æ–¥—Å–∫–∞–∑–∫–∞, –µ—Å–ª–∏ custom –≤—ã–±—Ä–∞–Ω, –Ω–æ –¥–∞—Ç—ã –µ—â—ë –Ω–µ –∑–∞–¥–∞–Ω—ã. */}
              {period === "custom" && !isCustomReady && (
                <p style={{ marginTop: -4, marginBottom: 8, opacity: 0.7 }}>
                  –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.
                </p>
              )}

              {/* –ü—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤; –∫–ª–∏–∫–æ–º –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–ø–∏—Å–∫—É. */}
              <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
                {chats.map((c) => (
                  <li
                    key={c.chat_id} // —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —Å–ø–∏—Å–∫–∞
                    style={{
                      padding: "10px 12px",
                      border: "1px solid #e5e7eb",
                      borderRadius: 8,
                      marginBottom: 8,
                      cursor: "pointer",
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                    }}
                    onClick={() => setSelectedChat(c.chat_id)}
                    title="–û—Ç–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É"
                  >
                    <span>
                      <b>@{c.username || "–±–µ–∑_–Ω–∏–∫–∞"}</b>
                    </span>
                    <span style={{ opacity: 0.7 }}>
                      {c.messages_total ?? 0} –≤—Å–µ–≥–æ /{" "}
                      {c.messages_in_period ?? 0} –∑–∞ –ø–µ—Ä–∏–æ–¥
                    </span>
                  </li>
                ))}
                {/* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≥–æ—Ç–æ–≤–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö. */}
                {chats.length === 0 && isCustomReady && (
                  <li style={{ opacity: 0.7 }}>–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç.</li>
                )}
              </ul>
            </>
          )}

          {/* –ö–æ–≥–¥–∞ —á–∞—Ç –≤—ã–±—Ä–∞–Ω ‚Äî —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏. */}
          {selectedChat && (
            <UserMessages
              chatId={selectedChat} // id —á–∞—Ç–∞ –¥–ª—è –±—ç–∫–µ–Ω–¥–∞
              onBack={() => setSelectedChat(null)} // –≤–æ–∑–≤—Ä–∞—Ç –∫ —Å–ø–∏—Å–∫—É
              period={period} // üî¥ –ø–µ—Ä–µ–¥–∞—ë–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ—Å–µ—Ç –ø–µ—Ä–∏–æ–¥–∞
              dateFrom={dateFrom} // üî¥ –∏ —è–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è custom
              dateTo={dateTo} // üî¥
            />
          )}
        </div>
      )}

      {/* –í–∫–ª–∞–¥–∫–∞ ¬´–ê–Ω–∞–ª–∏—Ç–∏–∫–∞¬ª: —Ñ–∏–ª—å—Ç—Ä—ã + ¬´—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è¬ª —Å–≤–æ–¥–∫–∞. */}
      {tab === "analytics" && !loading && (
        <div>
          {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–∞ —Å–ø—Ä–∞–≤–∞. */}
          <div
            style={{
              display: "flex",
              alignItems: "center",
              gap: 8,
              marginBottom: 12,
            }}
          >
            <h2 style={{ margin: 0 }}>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>

            <div style={{ marginLeft: "auto", display: "flex", gap: 8 }}>
              <label style={{ marginRight: 4 }}>–ü–µ—Ä–∏–æ–¥:</label>
              <select
                // –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π select –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è —Å–≤–æ–¥–∫–∏.
                value={period}
                onChange={(e) => setPeriod(e.target.value)}
              >
                <option value="day">–î–µ–Ω—å</option>
                <option value="week">–ù–µ–¥–µ–ª—è</option>
                <option value="month">30 –¥–Ω–µ–π</option>
                <option value="this_month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
                <option value="prev_month">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</option>
                <option value="custom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥</option>
              </select>

              {/* –ü—Ä–∏ custom ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–∞—Ç. */}
              {period === "custom" && (
                <>
                  <input
                    type="date"
                    value={dateFrom}
                    onChange={(e) => setDateFrom(e.target.value)}
                    title="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)"
                  />
                  <input
                    type="date"
                    value={dateTo}
                    onChange={(e) => setDateTo(e.target.value)}
                    title="–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞ (–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)"
                  />
                </>
              )}
            </div>
          </div>

          {/* –•–∏–Ω—Ç, –µ—Å–ª–∏ custom –≤—ã–±—Ä–∞–Ω, –Ω–æ –≥—Ä–∞–Ω–∏—Ü—ã –Ω–µ –∑–∞–¥–∞–Ω—ã. */}
          {period === "custom" && !isCustomReady && (
            <p style={{ marginTop: -4, marginBottom: 12, opacity: 0.7 }}>
              –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–¥–∫—É.
            </p>
          )}

          {/* ¬´–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è¬ª —Å–≤–æ–¥–∫–∞ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –ø–æ –ø–µ—Ä–∏–æ–¥—É. */}
          {isCustomReady && (
            <div
              style={{
                background: "#f8fafc",
                padding: 16,
                borderRadius: 8,
                border: "1px solid #e5e7eb",
                lineHeight: 1.6,
                maxWidth: 520,
              }}
            >
              <p style={{ margin: 0 }}>
                <b>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b> {summary.users_total ?? 0}
              </p>
              <p style={{ margin: 0 }}>
                <b>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π:</b> {summary.messages_total ?? 0}
              </p>
              <p style={{ margin: 0 }}>
                <b>–ò—Å—Ö–æ–¥—è—â–∏—Ö (–±–æ—Ç ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é):</b>{" "}
                {summary.messages_out ?? 0}
              </p>
              <p style={{ margin: 0 }}>
                <b>–í—Ö–æ–¥—è—â–∏—Ö (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –±–æ—Ç—É):</b>{" "}
                {summary.messages_in ?? 0}
              </p>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
